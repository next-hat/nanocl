Kind: Deployment
ApiVersion: v0.10

Args:
  - Name: name
    Kind: String
  - Name: domain
    Kind: String
  - Name: image
    Kind: String
  - Name: port
    Kind: Number
  - Name: ssl_enabled
    Kind: Boolean

Namespace: global

# See all options:
# https://docs.next-hat.com/references/nanocl/cargo
Cargoes:
  - Name: ${{ Args.name }}
    Container:
      Image: ${{ Args.image }}

# See all options:
# https://docs.next-hat.com/references/nanocl/resource
Resources:
  - Name: ${{ Args.domain }}
    Kind: ProxyRule
    Version: v0.7
    Config:
      Watch:
        - ${{ Args.name }}.global.c
      Rules:
        - Domain: ${{ Args.domain }}
          Network: Public
          # {% if Args.ssl_enabled %}
          Ssl:
            Certificate: /etc/letsencrypt/live/${{ Args.domain }}/fullchain.pem
            CertificateKey: /etc/letsencrypt/live/${{ Args.domain }}/privkey.pem
            Dhparam: /etc/letsencrypt/ssl-dhparams.pem
          Includes:
            - /etc/letsencrypt/options-ssl-nginx.conf
          # {% endif %}
          Locations:
            - Path: /
              Target:
                Key: ${{ Args.name }}.global.c
                Port: ${{ Args.port }}
